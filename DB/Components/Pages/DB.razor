@page "/weather"
@using System.Diagnostics
@using MySql.Data.MySqlClient;
@attribute [StreamRendering]

<PageTitle>Database</PageTitle>

<h1>Database</h1>


@if (entries == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in entries)
            {
                <tr>
                    <td>@entry.Id</td>
                    <td>@entry.Value</td>
                    <td>
                        <button @onclick="() => DeleteEntry(entry)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}



@code {

    private List<Test> entries = new List<Test>();

    private MySqlConnection _connection = new("server = localhost; user = root; password = insy; database = scottnew");

    protected override void OnInitialized()
    {
        _connection.Open();

        using var command = new MySqlCommand("SELECT * FROM emps;", _connection);
        using var reader = command.ExecuteReader();

        while (reader.Read())
        {
            int value1 = reader.GetInt32(0);
            string value2 = reader.GetString(1);
            entries.Add(new Test { Id = value1, Value = value2 });
        }
        _connection.Close();
    }

    public class Test
    {   
        public int Id { get; set; }
        public string Value { get; set; }
    }

    public void DeleteEntry(Test entry)
    {
        _connection.Open();
        var sql = "DELETE FROM emps WHERE id = @id";
        using var cmd = new MySqlCommand(sql, _connection);
        cmd.Parameters.AddWithValue("@id", entry.Id);
        cmd.ExecuteNonQuery();

        entries.Remove(entry);

        _connection.Close();

        OnInitialized();
    }

}
